consts={feed_boardid:"4f73a235dffd42106e00cc93",available_load_numbers:"4f73a235dffd42106e00cc9a",feed_delivered:"4f73a235dffd42106e00cc98",questions:"4f85c6dec943a92e0e30bcbc",web_controls:"4fc81ac349e99e8263620d13",drivers:"4fc81ac849e99e8263620e5a",destinations:"4fc81acf49e99e8263621574",sources:"4fc81ad149e99e82636215b7"};
$(document).ready(function(){setupLoginLogoutRefresh();$("#i_submit").click(function(a){a.preventDefault();submitClicked()});$("#d_trello_link").html('<a href="https://trello.com/board/feed/'+consts.feed_boardid+'">View Feed Board in Trello</a>');updateLoggedIn()});
var populateFields=function(){$("#d_driver").text("Loading boards...");populateDrivers();populateSources();populateDestinations();populateAvailableLoadNumbers();populateDate();populateNetWeight()},populateDrivers=function(){$("#d_drivers").html("Loading drivers...");getWebControl(consts.drivers,"s_driver",function(a){$("#d_drivers").html("Driver: "+a);$("#s_driver").val(localStorage["aultfarms.feed.driver"]);$("#s_driver").change(function(){var a=$("#s_driver").children(":selected").val();localStorage["aultfarms.feed.driver"]=
a})})},populateSources=function(){$("#d_sources").html("Loading sources...");getWebControl(consts.sources,"s_source",function(a){$("#d_sources").html("Source: "+a);$("#s_source").val(localStorage["aultfarms.feed.source"]);$("#s_source").change(function(){var a=$("#s_source").children(":selected").val();localStorage["aultfarms.feed.source"]=a;populateAvailableLoadNumbers()})})},populateDestinations=function(){$("#d_destinations").html("Loading destinations...");getWebControl(consts.destinations,"s_destination",
function(a){$("#d_destinations").html("Destination: "+a)})},populateAvailableLoadNumbers=function(){$("#d_load_numbers").html("Loading load numbers...");id=consts.available_load_numbers;trello_path="list/"+id+"/cards";sanitizer=function(a){var b=[];$.each(a,function(a,d){b[a]=new cache.DataItem(d.id,d.name)});return b};cache.get(id,trello_path,sanitizer,function(a){var b=getCurrentDataItem("#s_source",consts.sources);if(b){var b=splitString(",",b.data),a=filterDataItems(a,b,"-- Any --"==b[0]),c=b[0];
"-- Any --"==b[0]&&(c="");1>a.length?($("#d_load_numbers").html("Available #'s: None for this source"),$("#d_new_load_number").toggle(!0),$("#d_new_load_number").html('Enter New #: <input id="i_new_load_number" name="i_new_load_number" value="'+c+'"/>')):(a[a.length]={id:"NEW_LOAD",data:"-- New Load Number --"},$("#d_load_numbers").html("Available #'s: "+arrayToSelect(a,"s_load_numbers")),$("#d_new_load_number").html('Enter New #: <input id="i_new_load_number" name="i_new_load_number" value="'+c+
'"/>'),$("#d_new_load_number").toggle(!1),$("#s_load_numbers").change(function(){"NEW_LOAD"==$("#s_load_numbers").children(":selected").val()?$("#d_new_load_number").toggle(!0):$("#d_new_load_number").toggle(!1)}))}else $("#d_load_numbers").append('<a href="#" onClick="populateAvailableLoadNumbers();">Try again</a>')})},populateDate=function(){$("#d_date").html('Date: <input type="date" id="i_date" name="i_date" value="'+today()+'"/>')},populateNetWeight=function(){$("#d_net_weight").html('Net Lbs: <input type="number" id="i_net_weight" name="i_net_wieght" />')},
submitClicked=function(){clearUserMsg();cur_card=buildCardFromFields();if(msg=validateCard(cur_card))$("#d_msg").html("Error: "+msg);else{cardid=cur_card.load_number.id;name=cur_card.date+": ";name+=cur_card.load_number.data+".  ";name+=addCommasToInt(cur_card.net_weight)+" lbs - ";name+=cur_card.destination.data+" - ";name+=cur_card.driver.data;var a=function(a){debug("ERROR: ",a)};$("d_logged_in").scrollTop();"NEW_LOAD"==cardid?(userMsg("Creating new card in Feed Delivered..."),Trello.post("lists/"+
consts.feed_delivered+"/cards",{name:name,desc:"",idList:consts.feed_delivered},function(b){b.name!=name?debug("ERROR: failed to create new card."):(cardid=b.id,userMsg("Done.<br>"),userMsg("Moving card to bottom of list..."),trello_put("cards/"+cardid+"?pos=bottom",function(a){cache.reset();clearUserMsg();userMsg("Successfully created card: <br>",a.name)},a))},a)):(userMsg("Changing name..."),trello_put("cards/"+cardid+"?name="+name,function(b){b.name!=name?debug("ERROR: failed to change name on card.  Name is: ",
name):(userMsg("Done.<br>"),userMsg("Moving card to Feed Delivered..."),trello_put("cards/"+cardid+"?idList="+consts.feed_delivered,function(b){b.idList!=consts.feed_delivered?debug("ERROR: changed name, but failed to move card to Feed Delivered list."):(userMsg("Done.<br>"),userMsg("Moving card to bottom of list..."),trello_put("cards/"+cardid+"?pos=bottom",function(a){cache.reset();clearUserMsg();userMsg("Successfully moved card: <br>",a.name)},a))},a))},a))}},buildCardFromFields=function(){var a=
{};a.load_number=$("#i_new_load_number").is(":visible")?{id:"NEW_LOAD",data:$("#i_new_load_number").val()}:getCurrentDataItem("#s_load_numbers",consts.available_load_numbers);a.destination=getCurrentDataItem("#s_destination",consts.destinations);a.net_weight=$("#i_net_weight").val();a.date=$("#i_date").val().toString().trim();a.driver=getCurrentDataItem("#s_driver",consts.drivers);return a},validateCard=function(a){msg="";0>inArrayOfDataItems(a.load_number,cache.get(consts.available_load_numbers))&&
"NEW_LOAD"!=a.load_number.id&&(msg+="Load number invalid.  Internal Error.<br>");0>inArrayOfDataItems(a.destination,cache.get(consts.destinations))&&(msg+="Destination invalid.  Internal Error.<br>");isNaN(parseInt(a.net_weight))&&(msg+="Net Weight invalid: Try something like 45,000 or 45000<br>");a.date.match(/^[0-9]{4}-[0-9]{2}-[0-9]{2}$/)||(msg+="Date invalid: must be YYYY-MM-DD format.<br>");0>inArrayOfDataItems(a.driver,cache.get(consts.drivers))&&(msg+="Driver invalid: internal error<br>");
return msg};
