var debug=function(a){args=Array.prototype.slice.call(arguments);str="";$.each(args,function(a,b){str="string"==typeof b?str+b:str+JSON.stringify(b,!1,"  ")});$("#d_debug").append(str)},userMsg=function(a){args=Array.prototype.slice.call(arguments);str="";$.each(args,function(a,b){str="string"==typeof b?str+b:str+JSON.stringify(b,!1,"  ")});$("#d_msg").append(str)},clearUserMsg=function(){$("#d_msg").html("")};
consts={grain_boardid:"4f76f66783817e5055281d88",web_controls:"5012b90b58bd2a9f549f62ea",drivers:"5012b94458bd2a9f549f7188",destinations:"5012bacf237d94497770abfd",crops:"5012bb95237d944977715b04"};
$(document).ready(function(){Trello.authorize({interactive:!1,persist:!0,scope:{write:!0,read:!0},expiration:"30days",success:onAuthorize});$("#a_logout").click(function(){Trello.deauthorize();updateLoggedIn()});$("#a_connect_trello").click(function(){Trello.authorize({type:"popup",persist:!0,success:onAuthorize,scope:{write:!0,read:!0}})});$("#i_submit").click(function(a){a.preventDefault();submitClicked()});$("#d_trello_link").html('<a href="https://trello.com/board/grain-hauling/'+consts.grain_boardid+
'">View Grain Hauling Board in Trello</a>');updateLoggedIn()});
var updateLoggedIn=function(){var a=Trello.authorized();$("#d_not_logged_in").toggle(!a);$("#d_logged_in").toggle(a);a&&($("#d_driver").text("Loading boards..."),populateDrivers(),populateDestinations(),populateDate(),populateNetBu(),populateCrops(),populateSellers(),populateTicketNum())},onAuthorize=function(){updateLoggedIn();Trello.members.get("me",function(a){$("#fullName").text(a.fullName)})},cache={data:{},DataItem:function(a,c){this.id=a;this.data=c},get:function(a,c,b,d){if(1==arguments.length)return cache.data[a];
cache.data[a]?d(cache.data[a]):Trello.get(c,function(c){cache.data[a]=b(c);d(cache.data[a])})},reset:function(){cache.data={};updateLoggedIn()}},arrayToSelect=function(a,c){var b='<select name="'+c+'" id="'+c+'">';for(idx in a)b+='<option value="'+a[idx].id+'">'+a[idx].data+"</option>";return b+"</select>"},splitString=function(a,c){if("string"!=typeof c)return[];values=c.split(a);for(i=0;i<values.length;i++)values[i]=$.trim(values[i]),1>values[i].length&&(values.splice(i,1),i--);return values},getWebControl=
function(a,c,b){trello_path="card/"+a+"/desc";sanitizer=function(a){var c=splitString(";",a._value);$.each(c,function(a,b){c[a]=new cache.DataItem(b,b)});return c};cache.get(a,trello_path,sanitizer,function(a){b(arrayToSelect(a,c))})},getLists=function(a,c,b){trello_path="boards/"+a+"/lists";sanitizer=function(a){var c=[];$.each(a,function(a,b){b.id!=consts.web_controls&&(c[a]=new cache.DataItem(b.id,b.name))});return c};cache.get(a,trello_path,sanitizer,function(a){b(arrayToSelect(a,c))})},filterDataItems=
function(a,c,b){if(b)return a;var d=[];$.each(a,function(b,e){if(!e)return!0;cmp_str=e.data.toUpperCase();$.each(c,function(c,e){if(0<=cmp_str.indexOf(e.toUpperCase()))return d[b]=a[b],!1})});return d},populateDrivers=function(){$("#d_drivers").html("Loading drivers...");getWebControl(consts.drivers,"s_driver",function(a){$("#d_drivers").html("Driver: "+a);$("#s_driver").val(localStorage["aultfarms.feed.driver"]);$("#s_driver").change(function(){var a=$("#s_driver").children(":selected").val();localStorage["aultfarms.grain.driver"]=
a})})},populateDestinations=function(){$("#d_sources").html("Loading sources...");getWebControl(consts.sources,"s_source",function(a){$("#d_sources").html("Source: "+a);$("#s_source").val(localStorage["aultfarms.feed.source"]);$("#s_source").change(function(){var a=$("#s_source").children(":selected").val();localStorage["aultfarms.feed.source"]=a;populateAvailableLoadNumbers()})})},populateDestinations=function(){$("#d_destinations").html("Loading destinations...");getWebControl(consts.destinations,
"s_destination",function(a){$("#d_destinations").html("Destination: "+a);$("#s_destination").val(localStorage["aultfarms.grain.destination"]);$("#s_destination").change(function(){var a=$("#s_destination").children(":selected").val();localStorage["aultfarms.grain.destination"]=a})})},today=function(){var a=new Date,c=a.getFullYear(),b=a.getMonth()+1,a=a.getDate(),b=10>b?"0"+b:b.toString(),a=10>a?"0"+a:a.toString();return c+"-"+b+"-"+a},populateDate=function(){$("#d_date").html('Date: <input type="date" id="i_date" name="i_date" value="'+
today()+'"/>')},populateNetBu=function(){$("#d_net_bu").html('Net Bu: <input type="number" id="i_net_bu" name="i_net_bu" />')},populateCrops=function(){$("#d_crops").html("Loading crops...");getWebControl(consts.crops,"s_crop",function(a){$("#d_crops").html("Crop: "+a);$("#s_crop").val(localStorage["aultfarms.grain.crop"]);$("#s_crop").change(function(){var a=$("#s_crop").children(":selected").val();localStorage["aultfarms.grain.crop"]=a})})},populateSellers=function(){$("#d_sellers").html("Loading sellers...");
getLists(consts.grain_boardid,"s_seller",function(a){$("#d_sellers").html("Seller/List: "+a);$("#s_seller").val(localStorage["aultfarms.grain.seller"]);$("#s_seller").change(function(){var a=$("#s_seller").children(":selected").val();localStorage["aultfarms.grain.seller"]=a})})},populateTicketNum=function(){$("#d_ticket_num").html('Ticket #: <input type="text" id="i_ticket_num" name="i_ticket_num" />')};
function addCommas(a){x=(a+"").split(".");x1=x[0];x2=1<x.length?"."+x[1]:"";for(a=/(\d+)(\d{3})/;a.test(x1);)x1=x1.replace(a,"$1,$2");return x1+x2}
var submitClicked=function(){clearUserMsg();cur_card=buildCardFromFields();if(msg=validateCard(cur_card))$("#d_msg").html("Error: "+msg);else{name=cur_card.date+": ";name+=addCommas(cur_card.net_bu)+" bu ";name+=cur_card.crop.data.toUpperCase()+".  ";name+=cur_card.destination.data+" - ";name+="Tkt #"+cur_card.ticket_num+" - ";name+=cur_card.driver.data;listid=cur_card.seller_list.id;list_name=cur_card.seller_list.data;var a=function(){debug("ERROR: ",error)};$("d_logged_in").scrollTop();userMsg("Creating new card in "+
list_name+" ...");Trello.post("lists/"+listid+"/cards",{name:name,desc:"",idList:listid},function(c){c.name!=name?debug("ERROR: failed to create new card."):(cardid=c.id,userMsg("Done.<br>"),userMsg("Moving card to bottom of list..."),trello_put("cards/"+cardid+"?pos=bottom",function(a){cache.reset();clearUserMsg();userMsg("Successfully created card: <br>",a.name)},a))},a)}},getCurrentDataItem=function(a,c){id=$(a).children(":selected").val();arr=cache.get(c);for(idx in arr)if(arr[idx].id==id)return arr[idx]},
buildCardFromFields=function(){var a={};a.destination=getCurrentDataItem("#s_destination",consts.destinations);a.date=$("#i_date").val().toString().trim();a.driver=getCurrentDataItem("#s_driver",consts.drivers);a.net_bu=$("#i_net_bu").val();a.crop=getCurrentDataItem("#s_crop",consts.crops);a.ticket_num=$("#i_ticket_num").val();a.seller_list=getCurrentDataItem("#s_seller",consts.grain_boardid);return a},inArrayOfDataItems=function(a,c){var b=-1;$.each(c,function(c,f){if(f.id==a.id)return b=c,!1});
return b},validateCard=function(a){msg="";0>inArrayOfDataItems(a.destination,cache.get(consts.destinations))&&(msg+="Destination invalid.  Internal Error.<br>");isNaN(parseInt(a.net_bu))&&(msg+="Net Bushels invalid: Try something like 953 or 1,100 or 1038<br>");a.date.match(/^[0-9]{4}-[0-9]{2}-[0-9]{2}$/)||(msg+="Date invalid: must be YYYY-MM-DD format.<br>");0>inArrayOfDataItems(a.driver,cache.get(consts.drivers))&&(msg+="Driver invalid: internal error<br>");0>inArrayOfDataItems(a.seller_list,cache.get(consts.grain_boardid))&&
(msg+="Seller invalid: internal error<br>");0>inArrayOfDataItems(a.crop,cache.get(consts.crops))&&(msg+="Crop invalid: internal error<br>");1>$.trim(a.ticket_num).length&&(msg+="Ticket number invalid: cannot be blank.");return msg},refreshLinkClicked=function(){clearUserMsg();cache.reset()},trello_put=function(a,c,b){$.ajax({url:"https://api.trello.com/1/"+a,type:"GET",data:{key:Trello.key,token:Trello.token,_method:"PUT"},dataType:"jsonp",success:c,error:b})};
